import UIKit
import Kingfisher

// üéØ –ö–ê–°–¢–û–ú–ù–´–ô VIEWCONTROLLER –î–õ–Ø –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –° ID
class DeleteConfirmationViewController: UIViewController {
    
    // MARK: - Properties
    private let nftID: String
    private let nftImageURL: URL?
    
    // –ó–∞–º—ã–∫–∞–Ω–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ —Å CartViewController
    var onDeleteConfirmed: ((String) -> Void)?
    var onCancel: ((String) -> Void)?
    
    // MARK: - UI Elements
    private let backgroundBlurView = UIVisualEffectView()
    private let nftImageView = UIImageView()
    private let titleLabel = UILabel()
    private let buttonsContainerView = UIView()
    private let deleteButton = UIButton()
    private let cancelButton = UIButton()
    
    // MARK: - Initialization
    init(nftID: String, nftImageURL: URL? = nil) {
        self.nftID = nftID
        self.nftImageURL = nftImageURL
        super.init(nibName: nil, bundle: nil)
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    // MARK: - Lifecycle
    override func viewDidLoad() {
        
        super.viewDidLoad()
        setupUI()
        setupConstraints()
        setupActions()
        
        print("üóëÔ∏è –°–æ–∑–¥–∞–Ω DeleteConfirmationViewController –¥–ª—è NFT: \(nftID)")
    }
    
    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        animateAppearance()
    }
    
    // MARK: - Setup UI
    private func setupUI() {
        // üé≠ Blur —Ñ–æ–Ω —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å CartViewController —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º —Ä–∞–∑–º—ã—Ç–∏—è
        view.backgroundColor = .clear
        
        setupBlurBackground()
        
        //  NFT –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        setupNFTImageView()
        
        //  –¢–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        setupTitleLabel()
        
        //  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫
        setupButtonsContainer()
        
        //  –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" (—á–µ—Ä–Ω–∞—è)
        setupDeleteButton()
        
        //  –ö–Ω–æ–ø–∫–∞ "–í–µ—Ä–Ω—É—Ç—å—Å—è" (—á–µ—Ä–Ω–∞—è)
        setupCancelButton()
        
        //  –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∏–µ—Ä–∞—Ä—Ö–∏—é
        view.addSubview(backgroundBlurView)
        view.addSubview(nftImageView)
        view.addSubview(titleLabel)
        view.addSubview(buttonsContainerView)
        buttonsContainerView.addSubview(deleteButton)
        buttonsContainerView.addSubview(cancelButton)
    }
    
    private func setupBlurBackground() {
        //  –°–æ–∑–¥–∞–µ–º blur —ç—Ñ—Ñ–µ–∫—Ç
        backgroundBlurView.effect = nil // –ù–∞—á–∏–Ω–∞–µ–º –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        backgroundBlurView.alpha = 0
    }
    
    private func setupNFTImageView() {
        nftImageView.contentMode = .scaleAspectFill
        nftImageView.clipsToBounds = true
        nftImageView.layer.cornerRadius = 12
        nftImageView.backgroundColor = .systemGray6
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ NFT –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
        if let imageURL = nftImageURL {
            nftImageView.kf.setImage(
                with: imageURL,
                placeholder: createNFTPlaceholder(),
                options: [
                    .transition(.fade(0.3)),
                    .processor(DownsamplingImageProcessor(size: CGSize(width: 200, height: 200)))
                ]
            )
        } else {
            nftImageView.image = createNFTPlaceholder()
        }
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
        nftImageView.transform = CGAffineTransform(scaleX: 0.7, y: 0.7)
        nftImageView.alpha = 0
    }
    
    private func setupTitleLabel() {
        titleLabel.text = "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ\n—É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?"
        titleLabel.font = .systemFont(ofSize: 13, weight: .regular)
        titleLabel.textAlignment = .center
        titleLabel.textColor = .black
        titleLabel.numberOfLines = 0
        titleLabel.lineBreakMode = .byWordWrapping
        
        // –ù–∞—á–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
        titleLabel.transform = CGAffineTransform(translationX: 0, y: 20)
        titleLabel.alpha = 0
    }
    
    private func setupButtonsContainer() {
        buttonsContainerView.backgroundColor = .clear
        buttonsContainerView.alpha = 0
        buttonsContainerView.transform = CGAffineTransform(translationX: 0, y: 30)
    }
    
    private func setupDeleteButton() {
        deleteButton.setTitle("–£–¥–∞–ª–∏—Ç—å", for: .normal)
        deleteButton.backgroundColor = .black
        deleteButton.setTitleColor(UIColor(named: "YP Red"), for: .normal)
        deleteButton.titleLabel?.font = .systemFont(ofSize: 17, weight: .medium)
        deleteButton.layer.cornerRadius = 12
                
        // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è
        deleteButton.addTarget(self, action: #selector(deleteButtonTouchDown), for: .touchDown)
        deleteButton.addTarget(self, action: #selector(deleteButtonTouchUp), for: [.touchUpInside, .touchUpOutside, .touchCancel])
    }
    
    private func setupCancelButton() {
        cancelButton.setTitle("–í–µ—Ä–Ω—É—Ç—å—Å—è", for: .normal)
        cancelButton.backgroundColor = .black
        cancelButton.setTitleColor(.white, for: .normal)
        cancelButton.titleLabel?.font = .systemFont(ofSize: 17, weight: .medium)
        cancelButton.layer.cornerRadius = 12
        
        // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è
        cancelButton.addTarget(self, action: #selector(cancelButtonTouchDown), for: .touchDown)
        cancelButton.addTarget(self, action: #selector(cancelButtonTouchUp), for: [.touchUpInside, .touchUpOutside, .touchCancel])
    }
    
    // MARK: - Helper Methods
    private func createNFTPlaceholder() -> UIImage? {
        let size = CGSize(width: 200, height: 200)
        let renderer = UIGraphicsImageRenderer(size: size)
        
        return renderer.image { context in
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
            let colors = [UIColor.systemBlue.cgColor, UIColor.systemPurple.cgColor]
            let gradient = CGGradient(colorsSpace: CGColorSpaceCreateDeviceRGB(), colors: colors as CFArray, locations: nil)!
            
            context.cgContext.drawLinearGradient(
                gradient,
                start: CGPoint(x: 0, y: 0),
                end: CGPoint(x: size.width, y: size.height),
                options: []
            )
            
            // NFT –∏–∫–æ–Ω–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ
            let iconSize: CGFloat = 80
            let iconRect = CGRect(
                x: (size.width - iconSize) / 2,
                y: (size.height - iconSize) / 2,
                width: iconSize,
                height: iconSize
            )
            
            if let icon = UIImage(systemName: "photo.artframe")?.withTintColor(.white, renderingMode: .alwaysOriginal) {
                icon.draw(in: iconRect)
            }
        }
    }
    
    // MARK: - Constraints
    private func setupConstraints() {
        backgroundBlurView.translatesAutoresizingMaskIntoConstraints = false
        nftImageView.translatesAutoresizingMaskIntoConstraints = false
        titleLabel.translatesAutoresizingMaskIntoConstraints = false
        buttonsContainerView.translatesAutoresizingMaskIntoConstraints = false
        deleteButton.translatesAutoresizingMaskIntoConstraints = false
        cancelButton.translatesAutoresizingMaskIntoConstraints = false
        
        NSLayoutConstraint.activate([
            // Blur background –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            backgroundBlurView.topAnchor.constraint(equalTo: view.topAnchor),
            backgroundBlurView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            backgroundBlurView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            backgroundBlurView.bottomAnchor.constraint(equalTo: view.bottomAnchor),
            
            // NFT –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞
            nftImageView.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            nftImageView.centerYAnchor.constraint(equalTo: view.centerYAnchor, constant: -60),
            nftImageView.widthAnchor.constraint(equalToConstant: 108),
            nftImageView.heightAnchor.constraint(equalToConstant: 108),
            
            // –¢–µ–∫—Å—Ç –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            titleLabel.topAnchor.constraint(equalTo: nftImageView.bottomAnchor, constant: 12),
            titleLabel.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: 40),
            titleLabel.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -40),
            
            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ –ø–æ–¥ —Ç–µ–∫—Å—Ç–æ–º
            buttonsContainerView.topAnchor.constraint(equalTo: titleLabel.bottomAnchor, constant: 20),
            buttonsContainerView.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            buttonsContainerView.heightAnchor.constraint(equalToConstant: 44),
            buttonsContainerView.widthAnchor.constraint(equalToConstant: 262), // 127 + 8 + 127
            
            // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" —Å–ª–µ–≤–∞ (–ù–ê –û–î–ù–û–ú –£–†–û–í–ù–ï)
            deleteButton.topAnchor.constraint(equalTo: buttonsContainerView.topAnchor),
            deleteButton.bottomAnchor.constraint(equalTo: buttonsContainerView.bottomAnchor),
            deleteButton.leadingAnchor.constraint(equalTo: buttonsContainerView.leadingAnchor),
            deleteButton.widthAnchor.constraint(equalToConstant: 127),
            
            // –ö–Ω–æ–ø–∫–∞ "–í–µ—Ä–Ω—É—Ç—å—Å—è" —Å–ø—Ä–∞–≤–∞ (–ù–ê –û–î–ù–û–ú –£–†–û–í–ù–ï)
            cancelButton.topAnchor.constraint(equalTo: buttonsContainerView.topAnchor),
            cancelButton.bottomAnchor.constraint(equalTo: buttonsContainerView.bottomAnchor),
            cancelButton.leadingAnchor.constraint(equalTo: deleteButton.trailingAnchor, constant: 8),
            cancelButton.trailingAnchor.constraint(equalTo: buttonsContainerView.trailingAnchor),
            
        ])
    }
    
    // MARK: - Actions
    private func setupActions() {
        deleteButton.addTarget(self, action: #selector(deleteButtonTapped), for: .touchUpInside)
        cancelButton.addTarget(self, action: #selector(cancelButtonTapped), for: .touchUpInside)
        
        // –¢–∞–ø –ø–æ blur —Ñ–æ–Ω—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
        let tapGesture = UITapGestureRecognizer(target: self, action: #selector(backgroundTapped))
        backgroundBlurView.addGestureRecognizer(tapGesture)
    }
    
    @objc private func deleteButtonTapped() {
        print(" –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ NFT: \(nftID)")
        
        animateDisappearance {
            //  –£–≤–µ–¥–æ–º–ª—è–µ–º CartViewController –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è —Å ID
            self.onDeleteConfirmed?(self.nftID)
        }
    }
    
    @objc private func cancelButtonTapped() {
        print(" –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª —É–¥–∞–ª–µ–Ω–∏–µ NFT: \(nftID)")
        
        animateDisappearance {
            //  –£–≤–µ–¥–æ–º–ª—è–µ–º CartViewController –æ–± –æ—Ç–º–µ–Ω–µ —Å ID
            self.onCancel?(self.nftID)
        }
    }
    
    @objc private func backgroundTapped() {
        cancelButtonTapped()
    }
    
    // MARK: - Button Touch Effects
    @objc private func deleteButtonTouchDown() {
        UIView.animate(withDuration: 0.1) {
            self.deleteButton.transform = CGAffineTransform(scaleX: 0.95, y: 0.95)
        }
    }
    
    @objc private func deleteButtonTouchUp() {
        UIView.animate(withDuration: 0.1) {
            self.deleteButton.transform = .identity
        }
    }
    
    @objc private func cancelButtonTouchDown() {
        UIView.animate(withDuration: 0.1) {
            self.cancelButton.transform = CGAffineTransform(scaleX: 0.95, y: 0.95)
        }
    }
    
    @objc private func cancelButtonTouchUp() {
        UIView.animate(withDuration: 0.1) {
            self.cancelButton.transform = .identity
        }
    }
    
    // MARK: - Animations
    private func animateAppearance() {
        // –ê–Ω–∏–º–∞—Ü–∏—è blur —Ñ–æ–Ω–∞
        UIView.animate(withDuration: 0.3) {
            self.backgroundBlurView.alpha = 1
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º blur —ç—Ñ—Ñ–µ–∫—Ç —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        UIView.animate(withDuration: 0.4, delay: 0.1) {
            self.backgroundBlurView.effect = UIBlurEffect(style: .systemUltraThinMaterialLight)
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è NFT –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞—Å—à—Ç–∞–±)
        UIView.animate(
            withDuration: 0.5,
            delay: 0.1,
            usingSpringWithDamping: 0.7,
            initialSpringVelocity: 0.5,
            options: [.curveEaseOut]
        ) {
            self.nftImageView.transform = .identity
            self.nftImageView.alpha = 1
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (–ø–æ—è–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–∑—É)
        UIView.animate(
            withDuration: 0.4,
            delay: 0.3,
            options: [.curveEaseOut]
        ) {
            self.titleLabel.transform = .identity
            self.titleLabel.alpha = 1
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ (–ø–æ—è–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–∑—É)
        UIView.animate(
            withDuration: 0.4,
            delay: 0.5,
            options: [.curveEaseOut]
        ) {
            self.buttonsContainerView.transform = .identity
            self.buttonsContainerView.alpha = 1
        }
    }
    
    private func animateDisappearance(completion: @escaping () -> Void) {
        UIView.animate(
            withDuration: 0.25,
            delay: 0,
            options: [.curveEaseIn]
        ) {
            self.backgroundBlurView.alpha = 0
            self.backgroundBlurView.effect = nil
            self.nftImageView.transform = CGAffineTransform(scaleX: 0.8, y: 0.8)
            self.nftImageView.alpha = 0
            self.titleLabel.alpha = 0
            self.buttonsContainerView.alpha = 0
        } completion: { _ in
            self.dismiss(animated: false) {
                completion()
            }
        }
    }
}

// MARK: - Presentation Helper
extension DeleteConfirmationViewController {
    
    //  –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞
    static func present(from viewController: UIViewController,
                        nftID: String,
                        nftImageURL: URL? = nil,
                        onDelete: @escaping (String) -> Void,
                        onCancel: ((String) -> Void)? = nil) {
        
        let deleteVC = DeleteConfirmationViewController(nftID: nftID, nftImageURL: nftImageURL)
        deleteVC.modalPresentationStyle = .overFullScreen
        deleteVC.modalTransitionStyle = .crossDissolve
        
        deleteVC.onDeleteConfirmed = onDelete
        deleteVC.onCancel = onCancel
        
        viewController.present(deleteVC, animated: false)
    }
}

